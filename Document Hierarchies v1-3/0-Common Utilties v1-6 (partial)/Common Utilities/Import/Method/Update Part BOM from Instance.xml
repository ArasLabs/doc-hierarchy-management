<AML>
 <Item type="Method" id="C5F5C11679614670A2F55E5BF432C06B" action="add">
  <execution_allowed_to keyed_name="World" type="Identity">A73B655731924CD0B027E4F4D5FCC0A9</execution_allowed_to>
  <method_code><![CDATA[//System.Diagnostics.Debugger.Break();
String relship_id = this.getAttribute("typeId");
Item relationship = this.newItem("RelationshipType", "get");
if (String.IsNullOrEmpty(relship_id))
{
	relationship.setProperty("name", this.getAttribute("type"));
}
else
{
	relationship.setProperty("relationship_id", relship_id);
}
relationship.setAttribute("select", "name,source_id(name)");
relationship = relationship.apply();

if(relationship.isError())
{
  return relationship;
}

Item source_it = relationship.getPropertyItem("source_id");
String source_id = this.getProperty("source_id");

// read all BOM Instance relationships
Item qry = this.newItem(this.getType(),"get");
qry.setAttribute("serverEvents","0");
qry.setAttribute("select","sort_order,quantity,reference_designator,is_placed");
qry.setProperty("source_id",source_id);
qry=qry.apply();

double newParentPosQty = 0.0;
String newRefDesList = "##";
for (int i=0; i<qry.getItemCount(); i++) {
 String instanceQty = qry.getItemByIndex(i).getProperty("quantity","");
 if (instanceQty == "")
 {
   instanceQty = "1";
 }
 if (qry.getItemByIndex(i).getProperty("is_placed","0") == "1") 
 {
   newParentPosQty += double.Parse(instanceQty);	
   newRefDesList += "," + qry.getItemByIndex(i).getProperty("reference_designator","0");
 }
 else
 {
   newRefDesList += ",[" + qry.getItemByIndex(i).getProperty("reference_designator","0") + "]";
 }
}
newRefDesList = newRefDesList.Replace("##,","");

//update properties on Part BOM (source item) with SQL
String tableName = source_it.getProperty("name").Replace(" ","_");
String SQLstr = "";

SQLstr += "UPDATE [" + tableName + "] SET [" + tableName +"].quantity=" +newParentPosQty;

if (newRefDesList != "" && newRefDesList != "##") {
  SQLstr += ",[" + tableName +"].reference_designator='" +newRefDesList+ "'";
}
SQLstr += " WHERE [" + tableName + "].id='" + source_id + "'";
qry = this.getInnovator().applySQL(SQLstr);

return this;]]></method_code>
  <method_type>C#</method_type>
  <name>Update Part BOM from Instance</name>
 </Item>
</AML>