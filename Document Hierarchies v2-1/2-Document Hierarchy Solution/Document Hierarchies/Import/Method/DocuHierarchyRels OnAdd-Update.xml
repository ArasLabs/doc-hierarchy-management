<AML>
 <Item type="Method" id="672A0C23712D46CB8C22A50C21FFF5B4" action="add">
  <execution_allowed_to keyed_name="World" type="Identity">A73B655731924CD0B027E4F4D5FCC0A9</execution_allowed_to>
  <method_code><![CDATA[' called onAfterAdd/Update on Document Hierarchy relationships
'System.Diagnostics.Debugger.Break()
Dim thisItem As Item = Me.newItem(Me.GetType(),"get")
thisItem.setID(Me.GetID())
thisItem.setAttribute("select","sort_order,source_id(name,state,header_item_type,header_item_id_string,header_item_name,major_rev,owned_by_id,managed_by_id,team_id),related_id(owned_by_id,managed_by_id,team_id)")
thisItem.setAttribute("serverEvents","0")
thisItem = thisItem.apply()
If thisItem.isError() Then Return thisItem

'copy properties header_item_type and header_item_id_string
' from parent to child (source to related) item
Dim headerItemType As String = thisItem.getPropertyItem("source_id").getProperty("header_item_type","Null")
If (headerItemType = "Document Collection") Then headerItemType = "Document Book" '## compatibility with data generated by older versions of Document Hierarchies
Dim headerItemId As String = thisItem.getPropertyItem("source_id").getProperty("header_item_id_string","Null")
Dim headerItemName As String = thisItem.getPropertyItem("source_id").getProperty("header_item_name","Null")

If headerItemId = "Null" And headerItemType = "Null" Then Return Me ' nothing to do
If headerItemType <> "Null" Then headerItemType = "'" & headerItemType & "'"
If headerItemId <> "Null" Then headerItemId = "'" & headerItemId & "'"
If headerItemName <> "Null" Then headerItemName = "'" & headerItemName & "'"

Dim SQL As String =  "UPDATE [Document_Section] "
SQL = SQL & "SET [Document_Section].header_item_type=" & headerItemType
SQL = SQL & ", [Document_Section].header_item_id_string=" & headerItemId
SQL = SQL & ", [Document_Section].header_item_name=" & headerItemName

Dim value As String
value = thisItem.getPropertyItem("related_id").getProperty("owned_by_id","")
If value = "" Then
  value  = thisItem.getPropertyItem("source_id").getProperty("owned_by_id","")
  If value <> "" Then SQL = SQL & ", [Document_Section].owned_by_id='" & value & "'"
End If
value = thisItem.getPropertyItem("related_id").getProperty("managed_by_id","")
If value = "" Then
  value = thisItem.getPropertyItem("source_id").getProperty("managed_by_id","")
  If value <> "" Then SQL = SQL & ", [Document_Section].managed_by_id='" & value & "'"
End If
value = thisItem.getPropertyItem("related_id").getProperty("team_id","")
If value = "" Then
  value = thisItem.getPropertyItem("source_id").getProperty("team_id","")
  If value <> "" Then SQL = SQL & ", [Document_Section].team_id='" & value & "'"
End If

SQL = SQL & " WHERE [Document_Section].id='" & thisItem.getProperty("related_id","invald") & "'"

thisItem = Me.getInnovator().applySQL(SQL)
If thisItem.isError() Then Return thisItem

Return Me
]]></method_code>
  <method_type>VB</method_type>
  <name>DocuHierarchyRels OnAdd-Update</name>
 </Item>
</AML>